var CBL=function(d){var l={preprocess:function(){r("You should define a preprocess method!")},model_file:"",model_string:"",model_loaded:function(){},blob_min_pixels:1,blob_max_pixels:99999,pattern_width:20,pattern_height:20,pattern_maintain_ratio:false,blob_debug:"",allow_console_log:false,allow_console_warn:true,perceptive_colorspace:false,character_set:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"};d=d||{};for(var b in l){if(l.hasOwnProperty(b)&&!d.hasOwnProperty(b)){d[b]=l[b]}}var n={solve:function(w){return n.train(w)},train:function(x,B,C,z){var w="";var y;if(document.getElementById(x)!=null){y=document.getElementById(x)}else{y=document.createElement("img");y.src=x}var A=function(){if(!t){t=true;c=document.createElement("canvas");c.width=y.width;c.height=y.height;c.getContext("2d").drawImage(y,0,0);d.preprocess();var G=n.segmentBlobs(d.blob_min_pixels,d.blob_max_pixels,d.pattern_width,d.pattern_height,d.blob_debug);if(typeof B!=="undefined"&&typeof C!=="undefined"&&G.length){for(var D=0;D<G.length;D++){var F=G[D].toDataURL();var E=m(G[D]);q.push({imgSrc:F,pattern:E,imgId:B,txtId:C,self:n,onComplete:z})}if(!v){n.loadNextPattern()}v=true}else{for(var D=0;D<G.length;D++){w+=g(m(G[D]))}i("Solution = "+w)}n.reset()}};if(y.complete){A()}else{y.onload=A()}return w},loadNextPattern:function(){var w=q.pop();if(w){i("Loading a pattern for human classification.");document.getElementById(w.imgId).src=w.imgSrc;document.getElementById(w.txtId).focus();document.getElementById(w.txtId).onkeyup=function(x){var y=document.getElementById(w.txtId).value;if(d.character_set.indexOf(y)>-1&&y.length){e.push({pattern:w.pattern,solution:document.getElementById(w.txtId).value});i('Added "'+document.getElementById(w.txtId).value+'" pattern to model!');document.getElementById(w.txtId).value="";if(q.length){w.self.loadNextPattern()}else{v=false;document.getElementById(w.txtId).onkeyup=function(){};if(typeof w.onComplete==="function"){w.onComplete()}}}else{document.getElementById(w.txtId).value=""}}}},loadModelString:function(z){z=o.decompressFromBase64(z);e=new Array();var y=z.replace(/\[/g,"").split("]");for(var w=0;w<y.length;w++){var B=y[w].split("=");if(B.length==2){var A=B[1];var x=B[0];e.push({pattern:A,solution:x})}}if(!e.length){r("No patterns to load in provided model.")}else{i("Model loaded with "+e.length+" patterns!");d.model_loaded()}},loadModel:function(w){try{var y=new XMLHttpRequest();y.open("GET",w,true);y.send();y.onreadystatechange=function(){if(y.readyState==4&&y.status==200&&y.responseText){n.loadModelString(y.responseText)}}}catch(x){r('Could not load model from "'+w+'"! ('+x.message+")")}},saveModel:function(){var x="";for(var w=0;w<e.length;w++){x+="["+e[w].solution+"="+e[w].pattern+"]"}x=o.compressToBase64(x);return x},debugModel:function(){for(var w=0;w<e.length;w++){i(e[w].solution+" pattern length = "+e[w].pattern.split(".").length)}},condenseModel:function(){var C=new Array();var z=e.length;for(var B=0;B<e.length;B++){var y=e[B].pattern.split(".");var D=false;for(var A=0;A<C.length;A++){if(C[A].solution==e[B].solution){for(var w=0;w<C[A].tempArray.length;w++){C[A].tempArray[w]=parseInt(C[A].tempArray[w])+parseInt(y[w])}C[A].tempCount++;D=true;break}}if(!D){C.push({pattern:e[B].pattern,solution:e[B].solution,tempArray:y,tempCount:1})}}for(var B=0;B<C.length;B++){for(var w=0;w<C[B].tempArray.length;w++){C[B].tempArray[w]=Math.round(C[B].tempArray[w]/C[B].tempCount)}C[B].pattern=C[B].tempArray.join(".")}e=C;i("Condensed model from "+z+" patterns to "+e.length+" patterns!");return this},reset:function(w,x){t=false;c=null;return this},display:function(w){document.getElementById(w).src=c.toDataURL();return this},debugImage:function(w){var x=document.createElement("img");x.src=c.toDataURL();document.getElementById(w).appendChild(x);return this},segmentBlobs:function(S,P,R,C,O){if(typeof S==="undefined"){S=1}if(typeof P==="undefined"){P=100000}if(typeof R==="undefined"){R=20}if(typeof C==="undefined"){C=20}var M=c.getContext("2d").getImageData(0,0,c.width,c.height);var A=function(y,x){return y[x]*255*255+y[x+1]*256+y[x+2]};var G=new Array();for(var H=0;H<M.width;H++){for(var F=0;F<M.height;F++){var T=H*4+F*4*M.width;var w=A(M.data,T);if(!s(G,w)){G.push(w)}}}var V=new Array();for(var W=0;W<G.length;W++){var z=document.createElement("canvas");z.width=M.width;z.height=M.height;var N=z.getContext("2d").getImageData(0,0,c.width,c.height);var D=N.data;var L=0;var E=M.width;var Q=0;var I=M.height;var K=0;for(var H=0;H<M.width;H++){for(var F=0;F<M.height;F++){var T=H*4+F*4*M.width;var w=A(M.data,T);if(w==G[W]){D[T]=0;D[T+1]=0;D[T+2]=0;D[T+3]=255;L++;if(H<E){E=H}if(H>Q){Q=H}if(F<I){I=F}if(F>K){K=F}}else{D[T]=255;D[T+1]=255;D[T+2]=255;D[T+3]=255}}}if(L>=S&&L<=P){z.width=R;z.height=C;z.getContext("2d").putImageData(N,-E,-I,E,I,R,C);if(d.pattern_maintain_ratio){var B=Q-E;var J=K-I;if(B/R>J/C){z.getContext("2d").drawImage(z,0,0,R*R/(Q-E+1),C*C/(Q-E+1))}else{z.getContext("2d").drawImage(z,0,0,R*R/(K-I+1),C*C/(K-I+1))}}else{z.getContext("2d").drawImage(z,0,0,R*R/(Q-E+1),C*C/(K-I+1))}V.push(z);if(typeof O!=="undefined"&&O.length){i("Blob size = "+L);var U=document.createElement("img");U.src=z.toDataURL();document.getElementById(O).appendChild(U)}}}return V},colorRegions:function(A){var z=new Array();var C=c.getContext("2d").getImageData(0,0,c.width,c.height);for(var w=0;w<C.width;w++){for(var D=0;D<C.height;D++){var B=w*4+D*4*C.width;if(!s(z,B)){n.floodfill(w,D,p(),A,C,z)}}}c.getContext("2d").putImageData(C,0,0);return this},color:function(y,x,w){return{r:y,g:x,b:w,a:255}},floodfill:function(E,D,S,M,I,O){var J=false;if(typeof I==="undefined"){J=true;I=c.getContext("2d").getImageData(0,0,c.width,c.height)}var R=I.data;var A=R.length;var B=[];var L=(E+D*I.width)*4;var N=L,G=L,P,H,F=I.width*4;var z=[R[L],R[L+1],R[L+2],R[L+3]];var C=R[L]+R[L+1]+R[L+2]+R[L+3];if(!a(L,z,C,S,R,A,M)){return false}B.push(L);while(B.length){L=B.pop();if(typeof O!=="undefined"){if(s(O,L)){continue}}if(j(L,z,C,S,R,A,M,O)){N=L;G=L;H=(L/F)*F;P=H+F;while(H<(G-=4)&&j(G,z,C,S,R,A,M,O)){}while(P>(N+=4)&&j(N,z,C,S,R,A,M,O)){}for(var K=G;K<N;K+=4){if(K-F>=0&&a(K-F,z,C,S,R,A,M)){B.push(K-F)}if(K+F<A&&a(K+F,z,C,S,R,A,M)){B.push(K+F)}}}}if(J){c.getContext("2d").putImageData(I,0,0)}},blur:function(){var y=1;var w=c.getContext("2d");w.globalAlpha=0.3;for(var x=1;x<=8;x++){w.drawImage(c,y,0,c.width-y,c.height,0,0,c.width-y,c.height);w.drawImage(c,0,y,c.width,c.height-y,0,0,c.width,c.height-y)}},grayscale:function(){var B=c.getContext("2d").getImageData(0,0,c.width,c.height);for(var w=0;w<B.width;w++){for(var C=0;C<B.height;C++){var z=w*4+C*4*B.width;var A=0.34*B.data[z]+0.5*B.data[z+1]+0.16*B.data[z+2];B.data[z]=A;B.data[z+1]=A;B.data[z+2]=A;B.data[z+3]=255}}c.getContext("2d").putImageData(B,0,0);return this},binarize:function(z){var C=c.getContext("2d").getImageData(0,0,c.width,c.height);for(var w=0;w<C.width;w++){for(var D=0;D<C.height;D++){var A=w*4+D*4*C.width;var B=0.34*C.data[A]+0.5*C.data[A+1]+0.16*C.data[A+2];C.data[A]=B>=z?255:0;C.data[A+1]=B>=z?255:0;C.data[A+2]=B>=z?255:0;C.data[A+3]=255}}c.getContext("2d").putImageData(C,0,0);return this}};var e=new Array();var q=new Array();var v=false;var t=false;var c;var g=function(y){var z=4000000000;var w="?";for(var x=0;x<e.length;x++){i(e[x].pattern.length+" - "+y.length);var A=f(e[x].pattern,y);if(A<z){z=A;w=e[x].solution}}return w};var m=function(z){var B=new Array();var D=z.getContext("2d").getImageData(0,0,z.width,z.height);for(var w=0;w<D.width;w++){for(var E=0;E<D.height;E++){var A=w*4+E*4*D.width;var C=Math.round(0.34*D.data[A]+0.5*D.data[A+1]+0.16*D.data[A+2]);B.push(C)}}return B.join(".")};var f=function(B,A){var y=B.split(".");var x=A.split(".");var z=0;for(var w=0;w<y.length;w++){z+=(y[w]-x[w])*(y[w]-x[w])}return Math.sqrt(z/y.length)};var a=function(B,w,C,y,A,x,E){if(B<0||B>=x){return false}var F=k(w,0);var z=k(A,B);var D=y;if(u(F,D)==0){return false}else{if(u(F,z)==0){return true}}if(d.perceptive_colorspace){if(h(F,z)<=E){return true}}else{if(u(F,z)<=E){return true}}return false};var j=function(z,B,D,y,C,A,x,w){if(a(z,B,D,y,C,A,x)){if(typeof w!=="undefined"){if(s(w,z)){return false}}C[z]=y.r;C[z+1]=y.g;C[z+2]=y.b;C[z+3]=y.a;if(typeof w!=="undefined"){w.push(z)}return true}return false};var k=function(x,w){return{r:x[w],g:x[w+1],b:x[w+2]}};var u=function(x,w){return Math.max(Math.abs(x.r-w.r),Math.abs(x.g-w.g),Math.abs(x.g-w.g))};var u=function(x,w){return Math.sqrt((Math.pow(x.r-w.r,2),Math.pow(x.g-w.g,2),Math.pow(x.g-w.g,2))/3)};var h=function(y,w){var z=function(E,C){var D=x(A(E));var B=x(A(C));return Math.sqrt(Math.pow(D.l-B.l,2)+Math.pow(D.a-B.a,2)+Math.pow(D.b-B.b,2))};var A=function(E){var C=E.r/255;var B=E.g/255;var D=E.b/255;C=C>0.04045?Math.pow((C+0.055)/1.055,2.4):(C/12.92);B=B>0.04045?Math.pow((B+0.055)/1.055,2.4):(B/12.92);D=D>0.04045?Math.pow((D+0.055)/1.055,2.4):(D/12.92);C=C*100;B=B*100;D=D*100;return{x:C*0.4124+B*0.3576+D*0.1805,y:C*0.2126+B*0.7152+D*0.0722,z:C*0.0193+B*0.1192+D*0.9505}};var x=function(E){var D=E.x/95.047;var C=E.y/100;var B=E.z/108.883;D=D>0.008856?Math.pow(D,1/3):(7.787*D)+(16/116);C=C>0.008856?Math.pow(C,1/3):(7.787*C)+(16/116);B=B>0.008856?Math.pow(B,1/3):(7.787*B)+(16/116);return{l:(116*C)-16,a:500*(D-C),b:200*(C-B)}};return z(y,w)};var s=function(w,y){for(var x=0;x<w.length;x++){if(w[x]===y){return true}}return false};var p=function(){var y=Math.round(Math.random()*200)+55;var x;var w;while((x=Math.round(Math.random()*200)+55)==y){}while((w=Math.round(Math.random()*200)+55)==y||w==x){}return n.color(y,x,w)};var i=function(w){if(d.allow_console_log){console.log("CBL: "+w)}};var r=function(w){if(d.allow_console_warn){console.warn("CBL: "+w)}};if(d.model_file.length){n.loadModel(d.model_file)}else{if(d.model_string.length){n.loadModelString(d.model_string)}}var o=function(){function A(D,C){if(!x[D]){x[D]={};for(var E=0;E<D.length;E++){x[D][D.charAt(E)]=E}}return x[D][C]}var y=String.fromCharCode,B="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",z="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",x={},w={compressToBase64:function(D){if(null==D){return""}var C=w._compress(D,6,function(E){return B.charAt(E)});switch(C.length%4){default:case 0:return C;case 1:return C+"===";case 2:return C+"==";case 3:return C+"="}},decompressFromBase64:function(C){return null==C?"":""==C?null:w._decompress(C.length,32,function(D){return A(B,C.charAt(D))})},compressToUTF16:function(C){return null==C?"":w._compress(C,15,function(D){return y(D+32)})+" "},decompressFromUTF16:function(C){return null==C?"":""==C?null:w._decompress(C.length,16384,function(D){return C.charCodeAt(D)-32})},compressToUint8Array:function(G){for(var E=w.compress(G),H=new Uint8Array(2*E.length),F=0,C=E.length;C>F;F++){var D=E.charCodeAt(F);H[2*F]=D>>>8,H[2*F+1]=D%256}return H},decompressFromUint8Array:function(F){if(null===F||void 0===F){return w.decompress(F)}for(var G=new Array(F.length/2),E=0,C=G.length;C>E;E++){G[E]=256*F[2*E]+F[2*E+1]}var D=[];return G.forEach(function(H){D.push(y(H))}),w.decompress(D.join(""))},compressToEncodedURIComponent:function(C){return null==C?"":w._compress(C,6,function(D){return z.charAt(D)})},decompressFromEncodedURIComponent:function(C){return null==C?"":""==C?null:(C=C.replace(/ /g,"+"),w._decompress(C.length,32,function(D){return A(z,C.charAt(D))}))},compress:function(C){return w._compress(C,16,function(D){return y(D)})},_compress:function(E,C,F){if(null==E){return""}var L,R,I,S={},D={},Q="",N="",O="",H=2,K=3,J=2,M=[],G=0,P=0;for(I=0;I<E.length;I+=1){if(Q=E.charAt(I),Object.prototype.hasOwnProperty.call(S,Q)||(S[Q]=K++,D[Q]=!0),N=O+Q,Object.prototype.hasOwnProperty.call(S,N)){O=N}else{if(Object.prototype.hasOwnProperty.call(D,O)){if(O.charCodeAt(0)<256){for(L=0;J>L;L++){G<<=1,P==C-1?(P=0,M.push(F(G)),G=0):P++}for(R=O.charCodeAt(0),L=0;8>L;L++){G=G<<1|1&R,P==C-1?(P=0,M.push(F(G)),G=0):P++,R>>=1}}else{for(R=1,L=0;J>L;L++){G=G<<1|R,P==C-1?(P=0,M.push(F(G)),G=0):P++,R=0}for(R=O.charCodeAt(0),L=0;16>L;L++){G=G<<1|1&R,P==C-1?(P=0,M.push(F(G)),G=0):P++,R>>=1}}H--,0==H&&(H=Math.pow(2,J),J++),delete D[O]}else{for(R=S[O],L=0;J>L;L++){G=G<<1|1&R,P==C-1?(P=0,M.push(F(G)),G=0):P++,R>>=1}}H--,0==H&&(H=Math.pow(2,J),J++),S[N]=K++,O=String(Q)}}if(""!==O){if(Object.prototype.hasOwnProperty.call(D,O)){if(O.charCodeAt(0)<256){for(L=0;J>L;L++){G<<=1,P==C-1?(P=0,M.push(F(G)),G=0):P++}for(R=O.charCodeAt(0),L=0;8>L;L++){G=G<<1|1&R,P==C-1?(P=0,M.push(F(G)),G=0):P++,R>>=1}}else{for(R=1,L=0;J>L;L++){G=G<<1|R,P==C-1?(P=0,M.push(F(G)),G=0):P++,R=0}for(R=O.charCodeAt(0),L=0;16>L;L++){G=G<<1|1&R,P==C-1?(P=0,M.push(F(G)),G=0):P++,R>>=1}}H--,0==H&&(H=Math.pow(2,J),J++),delete D[O]}else{for(R=S[O],L=0;J>L;L++){G=G<<1|1&R,P==C-1?(P=0,M.push(F(G)),G=0):P++,R>>=1}}H--,0==H&&(H=Math.pow(2,J),J++)}for(R=2,L=0;J>L;L++){G=G<<1|1&R,P==C-1?(P=0,M.push(F(G)),G=0):P++,R>>=1}for(;;){if(G<<=1,P==C-1){M.push(F(G));break}P++}return M.join("")},decompress:function(C){return null==C?"":""==C?null:w._decompress(C.length,32768,function(D){return C.charCodeAt(D)})},_decompress:function(J,K,Q){var F,N,G,I,E,S,T,M,P=[],O=4,R=4,L=3,D="",C=[],H={val:Q(0),position:K,index:1};for(N=0;3>N;N+=1){P[N]=N}for(I=0,S=Math.pow(2,2),T=1;T!=S;){E=H.val&H.position,H.position>>=1,0==H.position&&(H.position=K,H.val=Q(H.index++)),I|=(E>0?1:0)*T,T<<=1}switch(F=I){case 0:for(I=0,S=Math.pow(2,8),T=1;T!=S;){E=H.val&H.position,H.position>>=1,0==H.position&&(H.position=K,H.val=Q(H.index++)),I|=(E>0?1:0)*T,T<<=1}M=y(I);break;case 1:for(I=0,S=Math.pow(2,16),T=1;T!=S;){E=H.val&H.position,H.position>>=1,0==H.position&&(H.position=K,H.val=Q(H.index++)),I|=(E>0?1:0)*T,T<<=1}M=y(I);break;case 2:return""}for(P[3]=M,G=M,C.push(M);;){if(H.index>J){return""}for(I=0,S=Math.pow(2,L),T=1;T!=S;){E=H.val&H.position,H.position>>=1,0==H.position&&(H.position=K,H.val=Q(H.index++)),I|=(E>0?1:0)*T,T<<=1}switch(M=I){case 0:for(I=0,S=Math.pow(2,8),T=1;T!=S;){E=H.val&H.position,H.position>>=1,0==H.position&&(H.position=K,H.val=Q(H.index++)),I|=(E>0?1:0)*T,T<<=1}P[R++]=y(I),M=R-1,O--;break;case 1:for(I=0,S=Math.pow(2,16),T=1;T!=S;){E=H.val&H.position,H.position>>=1,0==H.position&&(H.position=K,H.val=Q(H.index++)),I|=(E>0?1:0)*T,T<<=1}P[R++]=y(I),M=R-1,O--;break;case 2:return C.join("")}if(0==O&&(O=Math.pow(2,L),L++),P[M]){D=P[M]}else{if(M!==R){return null}D=G+G.charAt(0)}C.push(D),P[R++]=G+D.charAt(0),O--,G=D,0==O&&(O=Math.pow(2,L),L++)}}};return w}();"function"==typeof define&&define.amd?define(function(){return o}):"undefined"!=typeof module&&null!=module&&(module.exports=o);return n};