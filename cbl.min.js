var CBL=function(g){var t={preprocess:function(){E("You should define a preprocess method!")},model_file:"",model_string:"",model_loaded:function(){},training_complete:function(){},blob_min_pixels:1,blob_max_pixels:99999,blob_min_width:1,blob_min_height:1,pattern_width:20,pattern_height:20,pattern_maintain_ratio:false,pattern_auto_rotate:false,incorrect_segment_char:"\\",blob_debug:"",blob_console_debug:false,allow_console_log:false,allow_console_warn:true,perceptive_colorspace:false,character_set:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",fixed_blob_locations:[],exact_characters:-1,exact_characters_width:-1,exact_characters_play:-1,solve_method:"bvs",solve_search_pixel_factor:0.6};g=g||{};for(var b in t){if(t.hasOwnProperty(b)&&!g.hasOwnProperty(b)){g[b]=t[b]}}var v={solve:function(I){if(g.solve_method=="bvs"){return v.train(I,true)}else{if(g.solve_method=="scan"){return v.extract(I,"",true)}else{q("Invalid solve method specified.")}}},done:function(I){z(function(){I(x);p()})},train:function(I,J){if(typeof J==="undefined"){J=false}if(g.solve_method!="bvs"){q('The train method only works with the "bvs" solve_method.')}z(function(){var L;var K=false;if(document.getElementById(I)!=null){L=document.getElementById(I)}else{L=document.createElement("img");K=true}var M=function(){var N="";var O=document.createElement("canvas");O.width=L.width;O.height=L.height;O.getContext("2d").drawImage(L,0,0);var Q=new B(O);g.preprocess(Q);var T;if(g.fixed_blob_locations.length>0){T=Q.segmentBlocks(g.pattern_width,g.pattern_height,g.fixed_blob_locations,g.blob_debug)}else{T=Q.segmentBlobs(g.blob_min_pixels,g.blob_max_pixels,g.pattern_width,g.pattern_height,g.blob_debug)}if(!J){for(var P=0;P<T.length;P++){var S=T[P].toDataURL();var R=u(T[P]);D.push({imgSrc:S,pattern:R,imgId:j,txtId:f,self:v,onComplete:g.training_complete})}if(!H){v.loadNextPattern()}H=true}else{for(var P=0;P<T.length;P++){N+=n(u(T[P]))}q("Solution = "+N)}x=N;p()};if(L.complete&&!K){M()}else{L.onload=M;if(K){L.src=I}}});return this},extract:function(J,I,K){if(typeof K==="undefined"){K=false}if(typeof I==="undefined"&&!K){E("Solution must be provided.");return}if(g.solve_method!="scan"){q('The extract method only works with the "scan" solve_method.')}z(function(){var M;var L=false;if(document.getElementById(J)!=null){M=document.getElementById(J)}else{M=document.createElement("img");L=true}var N=function(O){var P=document.createElement("canvas");P.width=M.width;P.height=M.height;P.getContext("2d").drawImage(M,0,0);var R=new B(P);if(K){g.preprocess(R)}else{blobs=R.segmentBlobs(g.blob_min_pixels,g.blob_max_pixels,g.pattern_width,g.pattern_height,g.blob_debug,true)}if(!K){for(var Q=0;Q<blobs.length;Q++){h.push({pattern:u(blobs[Q]),solution:O[Q],width:blobs[Q].width,height:blobs[Q].height});q('Added "'+O[Q]+'" pattern to model!')}}else{O=m(R);q("Solution = "+O)}x=O;p()};if(M.complete&&!L){N(I)}else{M.onload=function(){N(I)};if(L){M.src=J}}});return this},loadNextPattern:function(){var I=D.pop();if(I){q("Loading a pattern for human classification.");C();document.getElementById(I.imgId).src=I.imgSrc;document.getElementById(I.txtId).focus();document.getElementById(I.txtId).onkeyup=function(J){var K=document.getElementById(I.txtId).value;if((g.character_set.indexOf(K)>-1&&K.length)||K==g.incorrect_segment_char){if(K!=g.incorrect_segment_char){h.push({pattern:I.pattern,solution:document.getElementById(I.txtId).value});q('Added "'+document.getElementById(I.txtId).value+'" pattern to model!')}else{q("Did not add bad segment to model.")}document.getElementById(I.txtId).value="";if(D.length){I.self.loadNextPattern()}else{H=false;document.getElementById(I.txtId).onkeyup=function(){};if(typeof I.onComplete==="function"){I.onComplete();e()}}}else{document.getElementById(I.txtId).value=""}}}},loadModelString:function(N){N=w.decompressFromBase64(N);h=new Array();var M=N.replace(/\[/g,"").split("]");for(var J=0;J<M.length;J++){var P=M[J].split("=");if(P.length==2){var O=P[1];var L=P[0];h.push({pattern:O,solution:L})}else{if(P.length==4){var L=P[0];var O=P[1];var I=P[2];var K=P[3];h.push({pattern:O,solution:L,width:I,height:K})}}}if(!h.length){E("No patterns to load in provided model.")}else{q("Model loaded with "+h.length+" patterns!");g.model_loaded()}},loadModel:function(I){try{var K=new XMLHttpRequest();K.open("GET",I,true);K.send();K.onreadystatechange=function(){if(K.readyState==4&&K.status==200&&K.responseText){v.loadModelString(K.responseText)}}}catch(J){E('Could not load model from "'+I+'"! ('+J.message+")")}},serializeModel:function(){var J="";for(var I=0;I<h.length;I++){J+="["+h[I].solution+"="+h[I].pattern+"="+h[I].width+"="+h[I].height+"]"}J=w.compressToBase64(J);return J},saveModel:function(){var J=v.serializeModel();var I=document.createElement("a");I.href="data:application/octet-stream,"+encodeURIComponent(J);I.setAttribute("download","cbl-model.dat");I.click()},debugModel:function(){for(var I=0;I<h.length;I++){q(h[I].solution+" pattern length = "+h[I].pattern.split(".").length)}},sortModel:function(){h=h.sort(function(J,I){return J.solution.localeCompare(I.solution)})},visualizeModel:function(L){for(var J=0;J<h.length;J++){var N=document.createElement("canvas");N.width=g.pattern_width;N.height=g.pattern_height;var P=N.getContext("2d").getImageData(0,0,g.pattern_width,g.pattern_height);var R=h[J].pattern.split(".");for(var Q=0;Q<g.pattern_width;Q++){for(var O=0;O<g.pattern_height;O++){var K=Q*4+O*4*g.pattern_width;var I=O+Q*g.pattern_width;P.data[K]=R[I];P.data[K+1]=R[I];P.data[K+2]=R[I];P.data[K+3]=255}}N.getContext("2d").putImageData(P,0,0);var M=document.createElement("img");M.src=N.toDataURL();document.getElementById(L).appendChild(M)}},condenseModel:function(){var N=new Array();var K=h.length;for(var M=0;M<h.length;M++){var J=h[M].pattern.split(".");var O=false;for(var L=0;L<N.length;L++){if(N[L].solution==h[M].solution){for(var I=0;I<N[L].tempArray.length;I++){N[L].tempArray[I]=parseInt(N[L].tempArray[I])+parseInt(J[I])}N[L].tempCount++;O=true;break}}if(!O){N.push({pattern:h[M].pattern,solution:h[M].solution,tempArray:J,tempCount:1})}}for(var M=0;M<N.length;M++){for(var I=0;I<N[M].tempArray.length;I++){N[M].tempArray[I]=Math.round(N[M].tempArray[I]/N[M].tempCount)}N[M].pattern=N[M].tempArray.join(".")}h=N;q("Condensed model from "+K+" patterns to "+h.length+" patterns!");return this}};var B=function(I){var J={colorRegions:function(M,P,R){if(typeof P==="undefined"){P=false}if(typeof R==="undefined"){R=0}var L=new Array();var O=I.getContext("2d").getImageData(0,0,I.width,I.height);for(var K=0;K<O.width;K++){for(var Q=0;Q<O.height;Q++){var N=K*4+Q*4*O.width;if(!F(L,N)){J.floodfill(K,Q,A(),M,O,L,P,R)}}}I.getContext("2d").putImageData(O,0,0);return this},display:function(K){document.getElementById(K).src=I.toDataURL();return this},debugImage:function(K){var L=document.createElement("img");L.src=I.toDataURL();document.getElementById(K).appendChild(L);return this},floodfill:function(R,O,af,aa,V,ac,Y,T){var W=false;if(typeof V==="undefined"){W=true;V=I.getContext("2d").getImageData(0,0,I.width,I.height)}if(typeof T==="undefined"){T=0}var ae=V.data;var L=ae.length;var M=[];var Z=(R+O*V.width)*4;var ab=Z,S=Z,ad,U,P=V.width*4;var K=[ae[Z],ae[Z+1],ae[Z+2],ae[Z+3]];var N=ae[Z]+ae[Z+1]+ae[Z+2]+ae[Z+3];if(!a(Z,K,N,af,ae,L,aa)){return false}M.push(Z);while(M.length){Z=M.pop();if(typeof ac!=="undefined"){if(F(ac,Z)){continue}}if(s(Z,K,N,af,ae,L,aa,ac,Y)){ab=Z;S=Z;U=(Z/P)*P;ad=U+P;while(U<(S-=4)&&s(S,K,N,af,ae,L,aa,ac,Y)){}while(ad>(ab+=4)&&s(ab,K,N,af,ae,L,aa,ac,Y)){}if(T>0){S-=T*4;ab+=T*4}for(var X=S;X<ab;X+=4){if(X-P>=0&&a(X-P,K,N,af,ae,L,aa)){M.push(X-P)}if(X+P<L&&a(X+P,K,N,af,ae,L,aa)){M.push(X+P)}}}}if(W){I.getContext("2d").putImageData(V,0,0)}},blur:function(K){if(typeof K==="undefined"){K=1}if(K==2){return this.convolute([[1,1,1,1,1],[1,1,1,1,1],[1,1,1,1,1],[1,1,1,1,1],[1,1,1,1,1]],1/25)}else{if(K==3){return this.convolute([[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1],[1,1,1,1,1,1,1]],1/49)}else{return this.convolute([[1,1,1],[1,1,1],[1,1,1]],1/9)}}},sharpen:function(){return this.convolute([[0,-1,0],[-1,5,-1],[0,-1,0]])},grayscale:function(){var N=I.getContext("2d").getImageData(0,0,I.width,I.height);for(var K=0;K<N.width;K++){for(var O=0;O<N.height;O++){var L=K*4+O*4*N.width;var M=0.34*N.data[L]+0.5*N.data[L+1]+0.16*N.data[L+2];N.data[L]=M;N.data[L+1]=M;N.data[L+2]=M;N.data[L+3]=255}}I.getContext("2d").putImageData(N,0,0);return this},removeGray:function(L){var O=I.getContext("2d").getImageData(0,0,I.width,I.height);for(var K=0;K<O.width;K++){for(var P=0;P<O.height;P++){var M=K*4+P*4*O.width;var N=Math.max(Math.abs(O.data[M]-O.data[M+1]),Math.abs(O.data[M+1]-O.data[M+2]),Math.abs(O.data[M+2]-O.data[M]));if(N<L){O.data[M]=255;O.data[M+1]=255;O.data[M+2]=255;O.data[M+3]=255}}}I.getContext("2d").putImageData(O,0,0);return this},binarize:function(L){var O=I.getContext("2d").getImageData(0,0,I.width,I.height);for(var K=0;K<O.width;K++){for(var P=0;P<O.height;P++){var M=K*4+P*4*O.width;var N=0.34*O.data[M]+0.5*O.data[M+1]+0.16*O.data[M+2];O.data[M]=N>=L?255:0;O.data[M+1]=N>=L?255:0;O.data[M+2]=N>=L?255:0;O.data[M+3]=255}}I.getContext("2d").putImageData(O,0,0);return this},convolute:function(X,T){var M=I.getContext("2d").getImageData(0,0,I.width,I.height);var P=I.getContext("2d").getImageData(0,0,I.width,I.height);var Z=X[0].length;var Q=X.length;var aa=Math.floor(Q/2);if(typeof T==="undefined"){T=1}var S=0;for(var V=0;V<M.height-1;V++){for(var W=0;W<M.width-1;W++){var Y=W*4+V*4*M.width;var K=0;var R=0;var U=0;for(var L=0;L<Z;L++){for(var O=0;O<Q;O++){var N=((V+(L-aa))*M.width+(W+(O-aa)))*4;K+=M.data[(N+M.data.length)%M.data.length]*X[L][O];R+=M.data[(N+1+M.data.length)%M.data.length]*X[L][O];U+=M.data[(N+2+M.data.length)%M.data.length]*X[L][O]}}P.data[Y+0]=T*K+S;P.data[Y+1]=T*R+S;P.data[Y+2]=T*U+S;P.data[Y+3]=255}}I.getContext("2d").putImageData(P,0,0);return this},erode:function(){return this.convolute([[-1,-1,-1],[-1,8,-1],[-1,-1,-1]])},foreach:function(N){var O=I.getContext("2d").getImageData(0,0,I.width,I.height);for(var K=0;K<O.width;K++){for(var P=0;P<O.height;P++){var M=K*4+P*4*O.width;var L={r:O.data[M+0],g:O.data[M+1],b:O.data[M+2]};L=N(L);O.data[M+0]=L.r;O.data[M+1]=L.g;O.data[M+2]=L.b;O.data[M+3]=255}}I.getContext("2d").putImageData(O,0,0);return this},invert:function(K){return this.foreach(function(L){L.r=255-L.r;L.g=255-L.g;L.b=255-L.b;return L})},cropRelative:function(O,N,L,K){var M=I.getContext("2d").getImageData(O,N,I.width-O-L,I.height-N-K);I.width=I.width-O-L;I.height=I.height-N-K;I.getContext("2d").putImageData(M,0,0);return this},getPixel:function(K,O){var N=I.getContext("2d").getImageData(0,0,I.width,I.height);var M=K*4+O*4*N.width;var L={r:N.data[M+0],g:N.data[M+1],b:N.data[M+2]};return L},segmentBlocks:function(Y,M,W,X,Q){if(typeof Y==="undefined"){Y=20}if(typeof M==="undefined"){M=20}if(typeof W==="undefined"){W=[]}if(typeof Q==="undefined"){Q=false}var T=I.getContext("2d").getImageData(0,0,I.width,I.height);var ac=new Array();for(var ad=0;ad<W.length;ad++){var K=document.createElement("canvas");K.width=T.width;K.height=T.height;var V=K.getContext("2d").getImageData(0,0,I.width,I.height);var N=V.data;var U=0;var O=W[ad].x1;var Z=W[ad].x2;var P=W[ad].y1;var S=W[ad].y2;var ab=document.createElement("canvas");ab.width=Z-O+1;ab.height=S-P+1;ab.getContext("2d").putImageData(T,-O,-P,O,P,ab.width,ab.height);K.width=Y;K.height=M;if(Q){K=ab}else{if(g.pattern_maintain_ratio){var L=ab.width;var R=ab.height;if(L/Y>R/M){K.getContext("2d").drawImage(ab,0,0,Y,R*(Y/L))}else{K.getContext("2d").drawImage(ab,0,0,L*(M/R),M)}}else{K.getContext("2d").drawImage(ab,0,0,Y,M)}}ac.push(K);if(typeof X!=="undefined"&&X.length){if(g.blob_console_debug){q("Blob size = "+U)}var aa=document.createElement("img");aa.src=K.toDataURL();document.getElementById(X).appendChild(aa)}}return ac},segmentBlobs:function(al,aD,aq,O,ae,ao){if(typeof al==="undefined"){al=1}if(typeof aD==="undefined"){aD=100000}if(typeof aq==="undefined"){aq=20}if(typeof O==="undefined"){O=20}if(typeof ao==="undefined"){ao=false}var N=I.getContext("2d").getImageData(0,0,I.width,I.height);var az=function(aF,aE){return aF[aE]*255*255+aF[aE+1]*256+aF[aE+2]};var K=az([255,255,255],0);var ax=new Array();for(var au=0;au<N.width;au++){for(var at=0;at<N.height;at++){var aA=au*4+at*4*N.width;var Q=az(N.data,aA);if(!F(ax,Q)&&Q!=K){ax.push(Q)}}}var af=new Array();for(var aB=0;aB<ax.length;aB++){var ag=document.createElement("canvas");ag.width=N.width;ag.height=N.height;var M=ag.getContext("2d").getImageData(0,0,I.width,I.height);var U=M.data;var T=0;var av=N.width;var P=0;var L=N.height;var am=0;for(var au=0;au<N.width;au++){for(var at=0;at<N.height;at++){var aA=au*4+at*4*N.width;var Q=az(N.data,aA);if(Q==ax[aB]){U[aA]=0;U[aA+1]=0;U[aA+2]=0;U[aA+3]=255;T++;if(au<av){av=au}if(au>P){P=au}if(at<L){L=at}if(at>am){am=at}}else{U[aA]=255;U[aA+1]=255;U[aA+2]=255;U[aA+3]=255}}}if(T>=al&&T<=aD&&P-av>=g.blob_min_width&&am-L>=g.blob_min_height){var S=document.createElement("canvas");S.width=P-av+1;S.height=am-L+1;S.getContext("2d").putImageData(M,-av,-L,av,L,S.width,S.height);ag.width=aq;ag.height=O;ag.orig_width=S.width;ag.orig_image=S;if(ao){ag=S}else{if(g.pattern_maintain_ratio){var ab=S.width;var aw=S.height;if(ab/aq>aw/O){ag.getContext("2d").drawImage(S,0,0,aq,aw*(aq/ab))}else{ag.getContext("2d").drawImage(S,0,0,ab*(O/aw),O)}}else{ag.getContext("2d").drawImage(S,0,0,aq,O)}}if(g.pattern_auto_rotate){ag=J.histogramRotate(ag)}af.push(ag)}}if(g.exact_characters>0){while(af.length<g.exact_characters){var aj=0;var aC=af[0].orig_width;for(var aA=1;aA<af.length;aA++){if(af[aA].orig_width>aC){aC=af[aA].orig_width;aj=aA}}var ar=2;if(g.exact_characters_width>0){ar=Math.ceil(aC/g.exact_characters_width);ar=Math.max(ar,2);ar=Math.min(ar,g.exact_characters-af.length+1)}for(var ah=1;ah<=ar;ah++){var ad=l(af[aj].orig_image);var M=ad.getContext("2d").getImageData(0,0,ad.width,ad.height);var X=ad.width/ar;av=Math.floor(X*(ah-1));P=Math.floor(X*ah);L=0;am=ad.height;if(g.exact_characters_play>0){var ai=0;var ay=0;for(var aa=av-g.exact_characters_play;aa<av+g.exact_characters_play;aa++){var W=0;for(var Y=L;Y<am;Y++){var Z=y(M,aa,Y);if(Z.r==255&&Z.g==255&&Z.b==255){W++}}if(W>ai){ay=aa;ai=W}}av=ay;var ac=0;var ap=0;for(var aa=P+g.exact_characters_play;aa>P-g.exact_characters_play;aa--){var V=0;for(var Y=L;Y<am;Y++){var Z=y(M,aa,Y);if(Z.r==255&&Z.g==255&&Z.b==255){V++}}if(V>ac){ap=aa;ac=V}}P=ap}for(var Y=L;Y<am&&L==0;Y++){for(var aa=av;aa<P&&L==0;aa++){var Z=y(M,aa,Y);if(Z.r!=255||Z.g!=255||Z.b!=255){L=Y}}}for(var Y=am-1;Y>L&&am==ad.height;Y--){for(var aa=av;aa<P&&am==ad.height;aa++){var Z=y(M,aa,Y);if(Z.r!=255||Z.g!=255||Z.b!=255){am=Y}}}var S=document.createElement("canvas");S.width=P-av+1;S.height=am-L+1;S.getContext("2d").putImageData(M,-av,-L,av,L,S.width,S.height);ad.width=aq;ad.height=O;ad.orig_width=S.width;ad.orig_image=S;if(g.pattern_maintain_ratio){var ab=S.width;var aw=S.height;if(ab/aq>aw/O){ad.getContext("2d").drawImage(S,0,0,aq,aw*(aq/ab))}else{ad.getContext("2d").drawImage(S,0,0,ab*(O/aw),O)}}else{ad.getContext("2d").drawImage(S,0,0,aq,O)}if(g.pattern_auto_rotate){ad=J.histogramRotate(ad)}af.splice(aj+ah,0,ad)}af.splice(aj,1);if(g.blob_console_debug){q("Large blob divided")}}while(af.length>g.exact_characters){var ak=0;var an=af[0].orig_width;for(var aA=1;aA<af.length;aA++){if(af[aA].orig_width<an){an=af[aA].orig_width;ak=aA}}af.splice(ak,1);if(g.blob_console_debug){q("Small blob removed")}}}if(typeof ae!=="undefined"&&ae.length){for(var aA=0;aA<af.length;aA++){if(g.blob_console_debug){q("Blob size = "+T)}var R=document.createElement("img");R.src=af[aA].toDataURL();document.getElementById(ae).appendChild(R)}}return af},histogramRotate:function(K){var S=new Image();S.src=K.toDataURL();var R=90;var O=5;var P=K;var M=K.width;for(var N=-R/2;N<=R/2;N+=O){var U=document.createElement("canvas");var T=U.getContext("2d");U.width=K.width;U.height=K.height;T.save();T.translate(K.width/2,K.height/2);T.rotate(N*Math.PI/180);T.drawImage(S,-S.width/2,-S.width/2);T.restore();var L=T.getImageData(0,0,U.width,U.height);var X=0;for(var W=0;W<L.width;W++){for(var V=0;V<L.height;V++){var Q=W*4+V*4*L.width;if(L.data[Q]!=255&&L.data[Q+3]!=0){X++;break}}}T.putImageData(L,0,0);if(X<M){M=X;P=U}}return P},getPatternLocations:function(R){var Y=false;var X=R.pattern.split(".");var S=[];var P=I.getContext("2d").getImageData(0,0,I.width,I.height);for(var V=0;V<P.width;V++){for(var T=0;T<P.height;T++){var O=0;var N=0;if(V+R.width<P.width&&T+R.height<P.height){var L="\r\n";var K="\r\n";for(var U=0;U<R.height;U++){for(var W=0;W<R.width;W++){var Q=(V+W)*4+(T+U)*4*P.width;var M={r:P.data[Q+0],g:P.data[Q+1],b:P.data[Q+2]};if(X[W*R.height+U]<128){N++;if(M.r<128){O++}}if(Y){L+=X[W*R.height+U]<128?"X":"-";K+=M.r<128?"X":"-"}}if(Y){L+="\r\n";K+="\r\n"}}if(Y&&O/N>=0.8){console.log(L);console.log(K);console.log(O/N);break;return[]}}O/=N;if(O>=g.solve_search_pixel_factor){S.push({left:V,score:O,guess:R.solution})}}}I.getContext("2d").putImageData(P,0,0);return S}};return J};var h=new Array();var D=new Array();var H=false;var i=new Array();var d=false;var x="";var z=function(I){i.push(I);if(!d){p()}};var p=function(){if(i.length){d=true;i.shift()()}else{d=false}};var n=function(K){var L=4000000000;var I="?";for(var J=0;J<h.length;J++){var M=k(h[J].pattern,K);if(M<L){L=M;I=h[J].solution}}return I};var m=function(M){var K="?";var N=[];for(var L=0;L<h.length;L++){var J=M.getPatternLocations(h[L]);if(J.length){for(var I=0;I<J.length;I++){N.push(J[I])}}}if(N.length){K="";if(g.exact_characters>0&&N.length>g.exact_characters){N.sort(function(P,O){return O.score-P.score});N.length=g.exact_characters}N.sort(function(P,O){return P.left-O.left});for(var I=0;I<N.length;I++){K+=N[I].guess}}return K};var u=function(J){var L=new Array();var N=J.getContext("2d").getImageData(0,0,J.width,J.height);for(var I=0;I<N.width;I++){for(var O=0;O<N.height;O++){var K=I*4+O*4*N.width;var M=Math.round(0.34*N.data[K]+0.5*N.data[K+1]+0.16*N.data[K+2]);if(N.data[K+3]<255){M=255}L.push(M)}}return L.join(".")};var l=function(I){var K=document.createElement("canvas");var J=K.getContext("2d");K.width=I.width;K.height=I.height;J.drawImage(I,0,0);return K};var k=function(N,M){var K=N.split(".");var J=M.split(".");var L=0;for(var I=0;I<K.length;I++){L+=(K[I]-J[I])*(K[I]-J[I])}return Math.sqrt(L/K.length)};var a=function(N,I,O,K,M,J,Q){if(N<0||N>=J){return false}var R=r(I,0);var L=r(M,N);var P=K;if(G(R,P)==0){return false}else{if(G(R,L)==0){return true}}if(g.perceptive_colorspace){if(o(R,L)<=Q){return true}}else{if(G(R,L)<=Q){return true}}return false};var s=function(M,I,N,K,L,J,Q,P,O){if(a(M,I,N,K,L,J,Q)){if(typeof P!=="undefined"){if(F(P,M)){return false}}if(!(O&&L[M]==255&&L[M+1]==255&&L[M+2]==255)){L[M]=K.r;L[M+1]=K.g;L[M+2]=K.b;L[M+3]=K.a}if(typeof P!=="undefined"){P.push(M)}return true}return false};var r=function(J,I){return{r:J[I],g:J[I+1],b:J[I+2]}};var G=function(J,I){return Math.sqrt((Math.pow(J.r-I.r,2),Math.pow(J.g-I.g,2),Math.pow(J.g-I.g,2))/3)};var o=function(K,I){var L=function(Q,O){var P=J(M(Q));var N=J(M(O));return Math.sqrt(Math.pow(P.l-N.l,2)+Math.pow(P.a-N.a,2)+Math.pow(P.b-N.b,2))};var M=function(Q){var O=Q.r/255;var N=Q.g/255;var P=Q.b/255;O=O>0.04045?Math.pow((O+0.055)/1.055,2.4):(O/12.92);N=N>0.04045?Math.pow((N+0.055)/1.055,2.4):(N/12.92);P=P>0.04045?Math.pow((P+0.055)/1.055,2.4):(P/12.92);O=O*100;N=N*100;P=P*100;return{x:O*0.4124+N*0.3576+P*0.1805,y:O*0.2126+N*0.7152+P*0.0722,z:O*0.0193+N*0.1192+P*0.9505}};var J=function(Q){var P=Q.x/95.047;var O=Q.y/100;var N=Q.z/108.883;P=P>0.008856?Math.pow(P,1/3):(7.787*P)+(16/116);O=O>0.008856?Math.pow(O,1/3):(7.787*O)+(16/116);N=N>0.008856?Math.pow(N,1/3):(7.787*N)+(16/116);return{l:(116*O)-16,a:500*(P-O),b:200*(O-N)}};return L(K,I)};var F=function(I,K){for(var J=0;J<I.length;J++){if(I[J]===K){return true}}return false};var c=function(K,J,I){return{r:K,g:J,b:I,a:255}};var A=function(){var K=Math.round(Math.random()*200)+55;var J;var I;while((J=Math.round(Math.random()*200)+55)==K){}while((I=Math.round(Math.random()*200)+55)==K||I==J){}return c(K,J,I)};var y=function(L,I,M){var K=I*4+M*4*L.width;var J={r:L.data[K+0],g:L.data[K+1],b:L.data[K+2]};return J};var j="cbl-pattern";var f="cbl-solution";var e=function(){document.getElementById("cbl-trainer").style.display="none"};var C=function(){if(document.getElementById("cbl-trainer")!=null){document.getElementById("cbl-trainer").style.display="flex"}else{var I=function(J,K){var L=document.createElement("div");L.innerHTML=K;while(L.children.length>0){J.appendChild(L.children[0])}};I(document.body,'<div id="cbl-trainer">    <div id="cbl-trainer-dialog">        <span id="cbl-close" onclick="">&cross;</span>        <h1>CBL-js Pattern Classifier</h1>        <p>Identify the character in the image below by typing it into the textbox.</p>        <p>Type <span class="cbl-discard">'+g.incorrect_segment_char+'</span> to discard a pattern if the image was not segmented properly.</p>        <div class="cbl-row">            <div class="cbl-cell-50 cbl-right">                <img id="'+j+'" />            </div>            <div class="cbl-cell-50">                <input id="'+f+'" type="text" />            </div>        </div>    </div>    <small><a href="https://github.com/skotz/cbl-js" target="_blank">CBL-js &copy; Scott Clayton</a></small></div>');document.getElementById("cbl-close").addEventListener("click",function(J){e();J.preventDefault()})}};var q=function(I){if(g.allow_console_log){console.log("CBL: "+I)}};var E=function(I){if(g.allow_console_warn){console.warn("CBL: "+I)}};var w=function(){function M(P,O){if(!J[P]){J[P]={};for(var Q=0;Q<P.length;Q++){J[P][P.charAt(Q)]=Q}}return J[P][O]}var K=String.fromCharCode,N="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",L="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",J={},I={compressToBase64:function(P){if(null==P){return""}var O=I._compress(P,6,function(Q){return N.charAt(Q)});switch(O.length%4){default:case 0:return O;case 1:return O+"===";case 2:return O+"==";case 3:return O+"="}},decompressFromBase64:function(O){return null==O?"":""==O?null:I._decompress(O.length,32,function(P){return M(N,O.charAt(P))})},compressToUTF16:function(O){return null==O?"":I._compress(O,15,function(P){return K(P+32)})+" "},decompressFromUTF16:function(O){return null==O?"":""==O?null:I._decompress(O.length,16384,function(P){return O.charCodeAt(P)-32})},compressToUint8Array:function(S){for(var Q=I.compress(S),T=new Uint8Array(2*Q.length),R=0,O=Q.length;O>R;R++){var P=Q.charCodeAt(R);T[2*R]=P>>>8,T[2*R+1]=P%256}return T},decompressFromUint8Array:function(R){if(null===R||void 0===R){return I.decompress(R)}for(var S=new Array(R.length/2),Q=0,O=S.length;O>Q;Q++){S[Q]=256*R[2*Q]+R[2*Q+1]}var P=[];return S.forEach(function(T){P.push(K(T))}),I.decompress(P.join(""))},compressToEncodedURIComponent:function(O){return null==O?"":I._compress(O,6,function(P){return L.charAt(P)})},decompressFromEncodedURIComponent:function(O){return null==O?"":""==O?null:(O=O.replace(/ /g,"+"),I._decompress(O.length,32,function(P){return M(L,O.charAt(P))}))},compress:function(O){return I._compress(O,16,function(P){return K(P)})},_compress:function(Q,O,R){if(null==Q){return""}var X,ad,U,ae={},P={},ac="",Z="",aa="",T=2,W=3,V=2,Y=[],S=0,ab=0;for(U=0;U<Q.length;U+=1){if(ac=Q.charAt(U),Object.prototype.hasOwnProperty.call(ae,ac)||(ae[ac]=W++,P[ac]=!0),Z=aa+ac,Object.prototype.hasOwnProperty.call(ae,Z)){aa=Z}else{if(Object.prototype.hasOwnProperty.call(P,aa)){if(aa.charCodeAt(0)<256){for(X=0;V>X;X++){S<<=1,ab==O-1?(ab=0,Y.push(R(S)),S=0):ab++}for(ad=aa.charCodeAt(0),X=0;8>X;X++){S=S<<1|1&ad,ab==O-1?(ab=0,Y.push(R(S)),S=0):ab++,ad>>=1}}else{for(ad=1,X=0;V>X;X++){S=S<<1|ad,ab==O-1?(ab=0,Y.push(R(S)),S=0):ab++,ad=0}for(ad=aa.charCodeAt(0),X=0;16>X;X++){S=S<<1|1&ad,ab==O-1?(ab=0,Y.push(R(S)),S=0):ab++,ad>>=1}}T--,0==T&&(T=Math.pow(2,V),V++),delete P[aa]}else{for(ad=ae[aa],X=0;V>X;X++){S=S<<1|1&ad,ab==O-1?(ab=0,Y.push(R(S)),S=0):ab++,ad>>=1}}T--,0==T&&(T=Math.pow(2,V),V++),ae[Z]=W++,aa=String(ac)}}if(""!==aa){if(Object.prototype.hasOwnProperty.call(P,aa)){if(aa.charCodeAt(0)<256){for(X=0;V>X;X++){S<<=1,ab==O-1?(ab=0,Y.push(R(S)),S=0):ab++}for(ad=aa.charCodeAt(0),X=0;8>X;X++){S=S<<1|1&ad,ab==O-1?(ab=0,Y.push(R(S)),S=0):ab++,ad>>=1}}else{for(ad=1,X=0;V>X;X++){S=S<<1|ad,ab==O-1?(ab=0,Y.push(R(S)),S=0):ab++,ad=0}for(ad=aa.charCodeAt(0),X=0;16>X;X++){S=S<<1|1&ad,ab==O-1?(ab=0,Y.push(R(S)),S=0):ab++,ad>>=1}}T--,0==T&&(T=Math.pow(2,V),V++),delete P[aa]}else{for(ad=ae[aa],X=0;V>X;X++){S=S<<1|1&ad,ab==O-1?(ab=0,Y.push(R(S)),S=0):ab++,ad>>=1}}T--,0==T&&(T=Math.pow(2,V),V++)}for(ad=2,X=0;V>X;X++){S=S<<1|1&ad,ab==O-1?(ab=0,Y.push(R(S)),S=0):ab++,ad>>=1}for(;;){if(S<<=1,ab==O-1){Y.push(R(S));break}ab++}return Y.join("")},decompress:function(O){return null==O?"":""==O?null:I._decompress(O.length,32768,function(P){return O.charCodeAt(P)})},_decompress:function(V,W,ac){var R,Z,S,U,Q,ae,af,Y,ab=[],aa=4,ad=4,X=3,P="",O=[],T={val:ac(0),position:W,index:1};for(Z=0;3>Z;Z+=1){ab[Z]=Z}for(U=0,ae=Math.pow(2,2),af=1;af!=ae;){Q=T.val&T.position,T.position>>=1,0==T.position&&(T.position=W,T.val=ac(T.index++)),U|=(Q>0?1:0)*af,af<<=1}switch(R=U){case 0:for(U=0,ae=Math.pow(2,8),af=1;af!=ae;){Q=T.val&T.position,T.position>>=1,0==T.position&&(T.position=W,T.val=ac(T.index++)),U|=(Q>0?1:0)*af,af<<=1}Y=K(U);break;case 1:for(U=0,ae=Math.pow(2,16),af=1;af!=ae;){Q=T.val&T.position,T.position>>=1,0==T.position&&(T.position=W,T.val=ac(T.index++)),U|=(Q>0?1:0)*af,af<<=1}Y=K(U);break;case 2:return""}for(ab[3]=Y,S=Y,O.push(Y);;){if(T.index>V){return""}for(U=0,ae=Math.pow(2,X),af=1;af!=ae;){Q=T.val&T.position,T.position>>=1,0==T.position&&(T.position=W,T.val=ac(T.index++)),U|=(Q>0?1:0)*af,af<<=1}switch(Y=U){case 0:for(U=0,ae=Math.pow(2,8),af=1;af!=ae;){Q=T.val&T.position,T.position>>=1,0==T.position&&(T.position=W,T.val=ac(T.index++)),U|=(Q>0?1:0)*af,af<<=1}ab[ad++]=K(U),Y=ad-1,aa--;break;case 1:for(U=0,ae=Math.pow(2,16),af=1;af!=ae;){Q=T.val&T.position,T.position>>=1,0==T.position&&(T.position=W,T.val=ac(T.index++)),U|=(Q>0?1:0)*af,af<<=1}ab[ad++]=K(U),Y=ad-1,aa--;break;case 2:return O.join("")}if(0==aa&&(aa=Math.pow(2,X),X++),ab[Y]){P=ab[Y]}else{if(Y!==ad){return null}P=S+S.charAt(0)}O.push(P),ab[ad++]=S+P.charAt(0),aa--,S=P,0==aa&&(aa=Math.pow(2,X),X++)}}};return I}();"function"==typeof define&&define.amd?define(function(){return w}):"undefined"!=typeof module&&null!=module&&(module.exports=w);if(g.model_file.length){v.loadModel(g.model_file)}else{if(g.model_string.length){v.loadModelString(g.model_string)}}return v};
