var CBL=function(e){var o={preprocess:function(){x("You should define a preprocess method!")},model_file:"",model_string:"",model_loaded:function(){},blob_min_pixels:1,blob_max_pixels:99999,pattern_width:20,pattern_height:20,pattern_maintain_ratio:false,blob_debug:"",blob_console_debug:false,allow_console_log:false,allow_console_warn:true,perceptive_colorspace:false,character_set:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"};e=e||{};for(var b in o){if(o.hasOwnProperty(b)&&!e.hasOwnProperty(b)){e[b]=o[b]}}var q={solve:function(B){return q.train(B)},done:function(B){t(function(){B(s);k()})},train:function(B,D,E,C){t(function(){var G;var F=false;if(document.getElementById(B)!=null){G=document.getElementById(B)}else{G=document.createElement("img");F=true}var H=function(){var I="";var J=document.createElement("canvas");J.width=G.width;J.height=G.height;J.getContext("2d").drawImage(G,0,0);var L=new v(J);e.preprocess(L);var O=L.segmentBlobs(e.blob_min_pixels,e.blob_max_pixels,e.pattern_width,e.pattern_height,e.blob_debug);if(typeof D!=="undefined"&&typeof E!=="undefined"&&O.length){for(var K=0;K<O.length;K++){var N=O[K].toDataURL();var M=p(O[K]);w.push({imgSrc:N,pattern:M,imgId:D,txtId:E,self:q,onComplete:C})}if(!A){q.loadNextPattern()}A=true}else{for(var K=0;K<O.length;K++){I+=i(p(O[K]))}l("Solution = "+I)}s=I;k()};if(G.complete&&!F){H()}else{G.onload=H;if(F){G.src=B}}});return this},loadNextPattern:function(){var B=w.pop();if(B){l("Loading a pattern for human classification.");document.getElementById(B.imgId).src=B.imgSrc;document.getElementById(B.txtId).focus();document.getElementById(B.txtId).onkeyup=function(C){var D=document.getElementById(B.txtId).value;if(e.character_set.indexOf(D)>-1&&D.length){f.push({pattern:B.pattern,solution:document.getElementById(B.txtId).value});l('Added "'+document.getElementById(B.txtId).value+'" pattern to model!');document.getElementById(B.txtId).value="";if(w.length){B.self.loadNextPattern()}else{A=false;document.getElementById(B.txtId).onkeyup=function(){};if(typeof B.onComplete==="function"){B.onComplete()}}}else{document.getElementById(B.txtId).value=""}}}},loadModelString:function(E){E=r.decompressFromBase64(E);f=new Array();var D=E.replace(/\[/g,"").split("]");for(var B=0;B<D.length;B++){var G=D[B].split("=");if(G.length==2){var F=G[1];var C=G[0];f.push({pattern:F,solution:C})}}if(!f.length){x("No patterns to load in provided model.")}else{l("Model loaded with "+f.length+" patterns!");e.model_loaded()}},loadModel:function(B){try{var D=new XMLHttpRequest();D.open("GET",B,true);D.send();D.onreadystatechange=function(){if(D.readyState==4&&D.status==200&&D.responseText){q.loadModelString(D.responseText)}}}catch(C){x('Could not load model from "'+B+'"! ('+C.message+")")}},saveModel:function(){var C="";for(var B=0;B<f.length;B++){C+="["+f[B].solution+"="+f[B].pattern+"]"}C=r.compressToBase64(C);return C},debugModel:function(){for(var B=0;B<f.length;B++){l(f[B].solution+" pattern length = "+f[B].pattern.split(".").length)}},condenseModel:function(){var G=new Array();var D=f.length;for(var F=0;F<f.length;F++){var C=f[F].pattern.split(".");var H=false;for(var E=0;E<G.length;E++){if(G[E].solution==f[F].solution){for(var B=0;B<G[E].tempArray.length;B++){G[E].tempArray[B]=parseInt(G[E].tempArray[B])+parseInt(C[B])}G[E].tempCount++;H=true;break}}if(!H){G.push({pattern:f[F].pattern,solution:f[F].solution,tempArray:C,tempCount:1})}}for(var F=0;F<G.length;F++){for(var B=0;B<G[F].tempArray.length;B++){G[F].tempArray[B]=Math.round(G[F].tempArray[B]/G[F].tempCount)}G[F].pattern=G[F].tempArray.join(".")}f=G;l("Condensed model from "+D+" patterns to "+f.length+" patterns!");return this}};var v=function(B){var C={colorRegions:function(F){var E=new Array();var H=B.getContext("2d").getImageData(0,0,B.width,B.height);for(var D=0;D<H.width;D++){for(var I=0;I<H.height;I++){var G=D*4+I*4*H.width;if(!y(E,G)){C.floodfill(D,I,u(),F,H,E)}}}B.getContext("2d").putImageData(H,0,0);return this},display:function(D){document.getElementById(D).src=B.toDataURL();return this},debugImage:function(D){var E=document.createElement("img");E.src=B.toDataURL();document.getElementById(D).appendChild(E);return this},floodfill:function(I,H,W,R,M,T){var N=false;if(typeof M==="undefined"){N=true;M=B.getContext("2d").getImageData(0,0,B.width,B.height)}var V=M.data;var E=V.length;var F=[];var P=(I+H*M.width)*4;var S=P,K=P,U,L,J=M.width*4;var D=[V[P],V[P+1],V[P+2],V[P+3]];var G=V[P]+V[P+1]+V[P+2]+V[P+3];if(!a(P,D,G,W,V,E,R)){return false}F.push(P);while(F.length){P=F.pop();if(typeof T!=="undefined"){if(y(T,P)){continue}}if(n(P,D,G,W,V,E,R,T)){S=P;K=P;L=(P/J)*J;U=L+J;while(L<(K-=4)&&n(K,D,G,W,V,E,R,T)){}while(U>(S+=4)&&n(S,D,G,W,V,E,R,T)){}for(var O=K;O<S;O+=4){if(O-J>=0&&a(O-J,D,G,W,V,E,R)){F.push(O-J)}if(O+J<E&&a(O+J,D,G,W,V,E,R)){F.push(O+J)}}}}if(N){B.getContext("2d").putImageData(M,0,0)}},blur:function(){var F=1;var D=B.getContext("2d");D.globalAlpha=0.3;for(var E=1;E<=8;E++){D.drawImage(B,F,0,B.width-F,B.height,0,0,B.width-F,B.height);D.drawImage(B,0,F,B.width,B.height-F,0,0,B.width,B.height-F)}},grayscale:function(){var G=B.getContext("2d").getImageData(0,0,B.width,B.height);for(var D=0;D<G.width;D++){for(var H=0;H<G.height;H++){var E=D*4+H*4*G.width;var F=0.34*G.data[E]+0.5*G.data[E+1]+0.16*G.data[E+2];G.data[E]=F;G.data[E+1]=F;G.data[E+2]=F;G.data[E+3]=255}}B.getContext("2d").putImageData(G,0,0);return this},binarize:function(E){var H=B.getContext("2d").getImageData(0,0,B.width,B.height);for(var D=0;D<H.width;D++){for(var I=0;I<H.height;I++){var F=D*4+I*4*H.width;var G=0.34*H.data[F]+0.5*H.data[F+1]+0.16*H.data[F+2];H.data[F]=G>=E?255:0;H.data[F+1]=G>=E?255:0;H.data[F+2]=G>=E?255:0;H.data[F+3]=255}}B.getContext("2d").putImageData(H,0,0);return this},segmentBlobs:function(X,U,W,H,T){if(typeof X==="undefined"){X=1}if(typeof U==="undefined"){U=100000}if(typeof W==="undefined"){W=20}if(typeof H==="undefined"){H=20}var R=B.getContext("2d").getImageData(0,0,B.width,B.height);var F=function(ad,ac){return ad[ac]*255*255+ad[ac+1]*256+ad[ac+2]};var L=new Array();for(var M=0;M<R.width;M++){for(var K=0;K<R.height;K++){var Y=M*4+K*4*R.width;var D=F(R.data,Y);if(!y(L,D)){L.push(D)}}}var aa=new Array();for(var ab=0;ab<L.length;ab++){var E=document.createElement("canvas");E.width=R.width;E.height=R.height;var S=E.getContext("2d").getImageData(0,0,B.width,B.height);var I=S.data;var Q=0;var J=R.width;var V=0;var N=R.height;var P=0;for(var M=0;M<R.width;M++){for(var K=0;K<R.height;K++){var Y=M*4+K*4*R.width;var D=F(R.data,Y);if(D==L[ab]){I[Y]=0;I[Y+1]=0;I[Y+2]=0;I[Y+3]=255;Q++;if(M<J){J=M}if(M>V){V=M}if(K<N){N=K}if(K>P){P=K}}else{I[Y]=255;I[Y+1]=255;I[Y+2]=255;I[Y+3]=255}}}if(Q>=X&&Q<=U){E.width=W;E.height=H;E.getContext("2d").putImageData(S,-J,-N,J,N,W,H);if(e.pattern_maintain_ratio){var G=V-J;var O=P-N;if(G/W>O/H){E.getContext("2d").drawImage(E,0,0,W*W/(V-J+1),H*H/(V-J+1))}else{E.getContext("2d").drawImage(E,0,0,W*W/(P-N+1),H*H/(P-N+1))}}else{E.getContext("2d").drawImage(E,0,0,W*W/(V-J+1),H*H/(P-N+1))}aa.push(E);if(typeof T!=="undefined"&&T.length){if(e.blob_console_debug){l("Blob size = "+Q)}var Z=document.createElement("img");Z.src=E.toDataURL();document.getElementById(T).appendChild(Z)}}}return aa}};return C};var f=new Array();var w=new Array();var A=false;var g=new Array();var d=false;var s="";var t=function(B){g.push(B);if(!d){k()}};var k=function(){if(g.length){d=true;g.shift()()}};var i=function(D){var E=4000000000;var B="?";for(var C=0;C<f.length;C++){var F=h(f[C].pattern,D);if(F<E){E=F;B=f[C].solution}}return B};var p=function(C){var E=new Array();var G=C.getContext("2d").getImageData(0,0,C.width,C.height);for(var B=0;B<G.width;B++){for(var H=0;H<G.height;H++){var D=B*4+H*4*G.width;var F=Math.round(0.34*G.data[D]+0.5*G.data[D+1]+0.16*G.data[D+2]);E.push(F)}}return E.join(".")};var h=function(G,F){var D=G.split(".");var C=F.split(".");var E=0;for(var B=0;B<D.length;B++){E+=(D[B]-C[B])*(D[B]-C[B])}return Math.sqrt(E/D.length)};var a=function(G,B,H,D,F,C,J){if(G<0||G>=C){return false}var K=m(B,0);var E=m(F,G);var I=D;if(z(K,I)==0){return false}else{if(z(K,E)==0){return true}}if(e.perceptive_colorspace){if(j(K,E)<=J){return true}}else{if(z(K,E)<=J){return true}}return false};var n=function(E,G,I,D,H,F,C,B){if(a(E,G,I,D,H,F,C)){if(typeof B!=="undefined"){if(y(B,E)){return false}}H[E]=D.r;H[E+1]=D.g;H[E+2]=D.b;H[E+3]=D.a;if(typeof B!=="undefined"){B.push(E)}return true}return false};var m=function(C,B){return{r:C[B],g:C[B+1],b:C[B+2]}};var z=function(C,B){return Math.max(Math.abs(C.r-B.r),Math.abs(C.g-B.g),Math.abs(C.g-B.g))};var z=function(C,B){return Math.sqrt((Math.pow(C.r-B.r,2),Math.pow(C.g-B.g,2),Math.pow(C.g-B.g,2))/3)};var j=function(D,B){var E=function(J,H){var I=C(F(J));var G=C(F(H));return Math.sqrt(Math.pow(I.l-G.l,2)+Math.pow(I.a-G.a,2)+Math.pow(I.b-G.b,2))};var F=function(J){var H=J.r/255;var G=J.g/255;var I=J.b/255;H=H>0.04045?Math.pow((H+0.055)/1.055,2.4):(H/12.92);G=G>0.04045?Math.pow((G+0.055)/1.055,2.4):(G/12.92);I=I>0.04045?Math.pow((I+0.055)/1.055,2.4):(I/12.92);H=H*100;G=G*100;I=I*100;return{x:H*0.4124+G*0.3576+I*0.1805,y:H*0.2126+G*0.7152+I*0.0722,z:H*0.0193+G*0.1192+I*0.9505}};var C=function(J){var I=J.x/95.047;var H=J.y/100;var G=J.z/108.883;I=I>0.008856?Math.pow(I,1/3):(7.787*I)+(16/116);H=H>0.008856?Math.pow(H,1/3):(7.787*H)+(16/116);G=G>0.008856?Math.pow(G,1/3):(7.787*G)+(16/116);return{l:(116*H)-16,a:500*(I-H),b:200*(H-G)}};return E(D,B)};var y=function(B,D){for(var C=0;C<B.length;C++){if(B[C]===D){return true}}return false};var c=function(D,C,B){return{r:D,g:C,b:B,a:255}};var u=function(){var D=Math.round(Math.random()*200)+55;var C;var B;while((C=Math.round(Math.random()*200)+55)==D){}while((B=Math.round(Math.random()*200)+55)==D||B==C){}return c(D,C,B)};var l=function(B){if(e.allow_console_log){console.log("CBL: "+B)}};var x=function(B){if(e.allow_console_warn){console.warn("CBL: "+B)}};if(e.model_file.length){q.loadModel(e.model_file)}else{if(e.model_string.length){q.loadModelString(e.model_string)}}var r=function(){function F(I,H){if(!C[I]){C[I]={};for(var J=0;J<I.length;J++){C[I][I.charAt(J)]=J}}return C[I][H]}var D=String.fromCharCode,G="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",E="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",C={},B={compressToBase64:function(I){if(null==I){return""}var H=B._compress(I,6,function(J){return G.charAt(J)});switch(H.length%4){default:case 0:return H;case 1:return H+"===";case 2:return H+"==";case 3:return H+"="}},decompressFromBase64:function(H){return null==H?"":""==H?null:B._decompress(H.length,32,function(I){return F(G,H.charAt(I))})},compressToUTF16:function(H){return null==H?"":B._compress(H,15,function(I){return D(I+32)})+" "},decompressFromUTF16:function(H){return null==H?"":""==H?null:B._decompress(H.length,16384,function(I){return H.charCodeAt(I)-32})},compressToUint8Array:function(L){for(var J=B.compress(L),M=new Uint8Array(2*J.length),K=0,H=J.length;H>K;K++){var I=J.charCodeAt(K);M[2*K]=I>>>8,M[2*K+1]=I%256}return M},decompressFromUint8Array:function(K){if(null===K||void 0===K){return B.decompress(K)}for(var L=new Array(K.length/2),J=0,H=L.length;H>J;J++){L[J]=256*K[2*J]+K[2*J+1]}var I=[];return L.forEach(function(M){I.push(D(M))}),B.decompress(I.join(""))},compressToEncodedURIComponent:function(H){return null==H?"":B._compress(H,6,function(I){return E.charAt(I)})},decompressFromEncodedURIComponent:function(H){return null==H?"":""==H?null:(H=H.replace(/ /g,"+"),B._decompress(H.length,32,function(I){return F(E,H.charAt(I))}))},compress:function(H){return B._compress(H,16,function(I){return D(I)})},_compress:function(J,H,K){if(null==J){return""}var Q,W,N,X={},I={},V="",S="",T="",M=2,P=3,O=2,R=[],L=0,U=0;for(N=0;N<J.length;N+=1){if(V=J.charAt(N),Object.prototype.hasOwnProperty.call(X,V)||(X[V]=P++,I[V]=!0),S=T+V,Object.prototype.hasOwnProperty.call(X,S)){T=S}else{if(Object.prototype.hasOwnProperty.call(I,T)){if(T.charCodeAt(0)<256){for(Q=0;O>Q;Q++){L<<=1,U==H-1?(U=0,R.push(K(L)),L=0):U++}for(W=T.charCodeAt(0),Q=0;8>Q;Q++){L=L<<1|1&W,U==H-1?(U=0,R.push(K(L)),L=0):U++,W>>=1}}else{for(W=1,Q=0;O>Q;Q++){L=L<<1|W,U==H-1?(U=0,R.push(K(L)),L=0):U++,W=0}for(W=T.charCodeAt(0),Q=0;16>Q;Q++){L=L<<1|1&W,U==H-1?(U=0,R.push(K(L)),L=0):U++,W>>=1}}M--,0==M&&(M=Math.pow(2,O),O++),delete I[T]}else{for(W=X[T],Q=0;O>Q;Q++){L=L<<1|1&W,U==H-1?(U=0,R.push(K(L)),L=0):U++,W>>=1}}M--,0==M&&(M=Math.pow(2,O),O++),X[S]=P++,T=String(V)}}if(""!==T){if(Object.prototype.hasOwnProperty.call(I,T)){if(T.charCodeAt(0)<256){for(Q=0;O>Q;Q++){L<<=1,U==H-1?(U=0,R.push(K(L)),L=0):U++}for(W=T.charCodeAt(0),Q=0;8>Q;Q++){L=L<<1|1&W,U==H-1?(U=0,R.push(K(L)),L=0):U++,W>>=1}}else{for(W=1,Q=0;O>Q;Q++){L=L<<1|W,U==H-1?(U=0,R.push(K(L)),L=0):U++,W=0}for(W=T.charCodeAt(0),Q=0;16>Q;Q++){L=L<<1|1&W,U==H-1?(U=0,R.push(K(L)),L=0):U++,W>>=1}}M--,0==M&&(M=Math.pow(2,O),O++),delete I[T]}else{for(W=X[T],Q=0;O>Q;Q++){L=L<<1|1&W,U==H-1?(U=0,R.push(K(L)),L=0):U++,W>>=1}}M--,0==M&&(M=Math.pow(2,O),O++)}for(W=2,Q=0;O>Q;Q++){L=L<<1|1&W,U==H-1?(U=0,R.push(K(L)),L=0):U++,W>>=1}for(;;){if(L<<=1,U==H-1){R.push(K(L));break}U++}return R.join("")},decompress:function(H){return null==H?"":""==H?null:B._decompress(H.length,32768,function(I){return H.charCodeAt(I)})},_decompress:function(O,P,V){var K,S,L,N,J,X,Y,R,U=[],T=4,W=4,Q=3,I="",H=[],M={val:V(0),position:P,index:1};for(S=0;3>S;S+=1){U[S]=S}for(N=0,X=Math.pow(2,2),Y=1;Y!=X;){J=M.val&M.position,M.position>>=1,0==M.position&&(M.position=P,M.val=V(M.index++)),N|=(J>0?1:0)*Y,Y<<=1}switch(K=N){case 0:for(N=0,X=Math.pow(2,8),Y=1;Y!=X;){J=M.val&M.position,M.position>>=1,0==M.position&&(M.position=P,M.val=V(M.index++)),N|=(J>0?1:0)*Y,Y<<=1}R=D(N);break;case 1:for(N=0,X=Math.pow(2,16),Y=1;Y!=X;){J=M.val&M.position,M.position>>=1,0==M.position&&(M.position=P,M.val=V(M.index++)),N|=(J>0?1:0)*Y,Y<<=1}R=D(N);break;case 2:return""}for(U[3]=R,L=R,H.push(R);;){if(M.index>O){return""}for(N=0,X=Math.pow(2,Q),Y=1;Y!=X;){J=M.val&M.position,M.position>>=1,0==M.position&&(M.position=P,M.val=V(M.index++)),N|=(J>0?1:0)*Y,Y<<=1}switch(R=N){case 0:for(N=0,X=Math.pow(2,8),Y=1;Y!=X;){J=M.val&M.position,M.position>>=1,0==M.position&&(M.position=P,M.val=V(M.index++)),N|=(J>0?1:0)*Y,Y<<=1}U[W++]=D(N),R=W-1,T--;break;case 1:for(N=0,X=Math.pow(2,16),Y=1;Y!=X;){J=M.val&M.position,M.position>>=1,0==M.position&&(M.position=P,M.val=V(M.index++)),N|=(J>0?1:0)*Y,Y<<=1}U[W++]=D(N),R=W-1,T--;break;case 2:return H.join("")}if(0==T&&(T=Math.pow(2,Q),Q++),U[R]){I=U[R]}else{if(R!==W){return null}I=L+L.charAt(0)}H.push(I),U[W++]=L+I.charAt(0),T--,L=I,0==T&&(T=Math.pow(2,Q),Q++)}}};return B}();"function"==typeof define&&define.amd?define(function(){return r}):"undefined"!=typeof module&&null!=module&&(module.exports=r);return q};